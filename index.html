<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D365-like Logistics Prototype</title>

  <!-- Fluent UI Web Components (pinned stable) -->
  <script type="module" src="https://unpkg.com/@fluentui/web-components@2.6.1"></script>

  <style>
    :root{
      --bg: #f5f6f8;
      --panel: #ffffff;
      --border: #e1e3e6;
      --text: #1b1a19;
      --muted: #605e5c;
      --shadow: 0 1px 2px rgba(0,0,0,.06), 0 6px 24px rgba(0,0,0,.06);
      --radius: 12px;
      --topbar-h: 48px;
      --nav-w: 260px;
      --accent: #106ebe;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: Segoe UI, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* Shell */
    .shell{
      height:100vh;
      display:grid;
      grid-template-rows: var(--topbar-h) 1fr;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 14px;
      background: var(--panel);
      border-bottom:1px solid var(--border);
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .brand .title{ font-weight: 600; }
    .brand .subtitle{ color: var(--muted); font-size: 12px; }

    /* Main layout */
    .main{
      min-height:0;
      display:grid;
      grid-template-columns: var(--nav-w) 1fr;
    }

    /* Sidebar */
    .sidebar{
      background: var(--panel);
      border-right:1px solid var(--border);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .nav-title{ font-weight: 600; }
    .nav-section{
      margin-top: 6px;
      padding-top: 10px;
      border-top:1px solid var(--border);
    }
    .nav-section small{ color: var(--muted); display:block; margin: 0 6px 8px; }
    .nav-btn{ width:100%; display:flex; justify-content:flex-start; }

    /* Content */
    .content{
      padding: 16px;
      min-height:0;
      overflow:auto;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      min-height: calc(100vh - var(--topbar-h) - 32px);
    }

    /* Common */
    .row{ display:flex; gap:10px; align-items:center; }
    .row.wrap{ flex-wrap:wrap; }
    .space{ flex:1; }
    .muted{ color: var(--muted); }
    .h1{ font-size: 18px; font-weight: 650; margin:0; }
    .h2{ font-size: 14px; font-weight: 650; margin:0; }
    .divider{ height:1px; background: var(--border); margin: 12px 0; }

    .notice{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 10px;
      padding:10px;
      margin: 10px 0;
    }
    .notice.ok{ border-color:#c7e0c2; background:#f3fff2; }
    .notice.err{ border-color:#f2b8b5; background:#fff6f5; }
    .notice.warn{ border-color:#f6d27a; background:#fffbf0; }

    .grid-2{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 12px;
      min-height:0;
    }
    @media (max-width: 1100px){
      .main{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .grid-2{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 12px;
      min-height:0;
    }

    /* Boxes list */
    .box-list{ display:flex; flex-direction:column; gap:10px; }
    .box-item{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      cursor:pointer;
      background: #fff;
      transition: transform .05s ease;
    }
    .box-item:hover{ transform: translateY(-1px); }
    .box-item.active{ outline: 2px solid rgba(16,110,190,.25); }
    .box-top{ display:flex; align-items:center; gap:10px; }
    .box-meta{ margin-top: 6px; display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background:#fff;
    }
    .pill.good{ border-color:#c7e0c2; background:#f3fff2; color:#1a5e1a; }
    .pill.bad{ border-color:#f2b8b5; background:#fff6f5; color:#a4262c; }
    .pill.warn{ border-color:#f6d27a; background:#fffbf0; color:#8a5a00; }

    /* Items */
    .items{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .item-row{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background:#fff;
      display:grid;
      grid-template-columns: 1.6fr 0.7fr 1.0fr;
      gap:10px;
      align-items:start;
    }
    .item-meta{ display:flex; flex-direction:column; gap:4px; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      width: fit-content;
    }
    .tag.wo{ border-color: rgba(16,110,190,.35); color: var(--accent); }
    .tag.vs{ border-color: rgba(138,90,0,.35); color: #8a5a00; }

    .status-badge{
      display:inline-flex;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      width: fit-content;
    }
    .status-badge.recv{ background:#f3fff2; border-color:#c7e0c2; color:#1a5e1a; }
    .status-badge.miss{ background:#fff6f5; border-color:#f2b8b5; color:#a4262c; }
    .status-badge.dmg{ background:#fffbf0; border-color:#f6d27a; color:#8a5a00; }

    .file-box{
      margin-top: 8px;
      padding: 8px;
      border:1px dashed var(--border);
      border-radius: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      background:#fff;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    .table th, .table td{
      text-align:left;
      padding:10px;
      border-bottom:1px solid var(--border);
      font-size: 13px;
      vertical-align: top;
    }
    .table th{ background:#fafafa; color: var(--muted); font-weight: 600; }
    .table tr:last-child td{ border-bottom:none; }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="shell">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">
        <div class="title">Field Service</div>
        <div class="subtitle">Logistics prototype (D365-like)</div>
      </div>
      <div class="row">
        <span class="muted" style="font-size:12px">Technician: T-0042</span>
        <fluent-button appearance="subtle" id="btnFakeSettings">Settings</fluent-button>
      </div>
    </div>

    <div class="main">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="nav-title">Navigation</div>

        <div class="nav-section">
          <small>Logistics</small>

          <fluent-button class="nav-btn" id="navDeliveries" appearance="primary">
            Delivery Boxes
          </fluent-button>

          <fluent-button class="nav-btn" id="navVanStock" appearance="subtle">
            Van Stock Reserved
          </fluent-button>
        </div>

        <div class="nav-section">
          <small>Notes</small>
          <div class="muted" style="font-size:12px; line-height:1.4; padding: 0 6px;">
            • Box içindeki parçalar ikiye ayrılır: <b>WO-related</b> ve <b>Van Stock Reserved</b> (WO’suz).<br/>
            • Damaged seçilirse <b>dosya</b> + <b>not</b> zorunlu.
          </div>
        </div>
      </aside>

      <!-- Content -->
      <main class="content">
        <div class="card">
          <!-- Pages -->
          <section id="pageDeliveries"></section>
          <section id="pageVanStock" class="hidden"></section>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ----------------------------
    // Mock Data (edit freely)
    // ----------------------------
    const MOCK = {
      boxes: [
        {
          boxId: "BX-102938",
          shipDate: "2025-12-28T10:30:00Z",
          items: [
            // WO-related
            { id:"i1", partId:"P-100012", desc:"Thermostat assembly", qty:1, woId:"WO-450012", status:"Pending", note:"", fileName:"" },
            { id:"i2", partId:"P-100201", desc:"Water inlet valve", qty:2, woId:"WO-450012", status:"Pending", note:"", fileName:"" },
            // Van Stock Reserved (WO-unassigned)
            { id:"i3", partId:"P-100311", desc:"Door seal gasket", qty:1, woId:null, status:"Pending", note:"", fileName:"" }
          ]
        },
        {
          boxId: "BX-774401",
          shipDate: "2025-12-27T15:05:00Z",
          items: [
            // WO-related
            { id:"i4", partId:"P-101010", desc:"Control board", qty:1, woId:"WO-450099", status:"Pending", note:"", fileName:"" },
            // Van Stock Reserved
            { id:"i5", partId:"P-100777", desc:"Hose kit", qty:1, woId:null, status:"Pending", note:"", fileName:"" }
          ]
        }
      ],
      vanStockReserved: [
        { partId:"P-100311", desc:"Door seal gasket", qtyReserved: 1, lastUpdated:"2025-12-29T08:15:00Z" },
        { partId:"P-100777", desc:"Hose kit", qtyReserved: 2, lastUpdated:"2025-12-29T08:15:00Z" }
      ]
    };

    // ----------------------------
    // State
    // ----------------------------
    const state = {
      route: "deliveries", // deliveries | vanstock
      boxIdInput: "",
      selectedBoxId: null,
      workingBox: null, // deep copy of selected box for editing
      message: null // { type: "ok"|"err"|"warn", text: string }
    };

    // ----------------------------
    // Utilities
    // ----------------------------
    const $ = (sel) => document.querySelector(sel);
    const escapeHtml = (s) => (s ?? "").toStrin
