<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Technician Van Stock - Mockup</title>
  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --success:#16a34a;
      --warning:#f59e0b;
      --danger:#ef4444;
      --info:#0284c7;
      --chip-bg:#eef2ff;
      font-family:Inter, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    body{margin:0;background:var(--bg);color:#0f172a;}
    .app{max-width:980px;margin:18px auto;padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .tech{display:flex;align-items:center;gap:12px;}
    .tech h1{margin:0;font-size:18px;}
    .meta{font-size:13px;color:var(--muted);}
    .controls{display:flex;gap:8px;align-items:center;}
    .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;}
    .btn.secondary{background:#fff;border:1px solid #e2e8f0;color:var(--muted);}
    .tabs{display:flex;gap:8px;margin:12px 0;}
    .tab{padding:10px 14px;background:var(--card);border-radius:10px;cursor:pointer;border:1px solid transparent;}
    .tab.active{border-color:#c7d2fe;background:linear-gradient(180deg,#fbfdff,#f7f9ff);}
    .cards{display:flex;gap:10px;margin:10px 0 20px;}
    .card{background:var(--card);padding:12px;border-radius:10px;flex:1;box-shadow:0 1px 2px rgba(15,23,42,0.04);}
    .list{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 1px 2px rgba(15,23,42,0.04);}
    .row{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px dashed #eef2ff;}
    .row:last-child{border-bottom:none;}
    .part-id{font-weight:600;}
    .desc{color:var(--muted);font-size:13px;}
    .qtys{display:flex;gap:8px;align-items:center;margin-left:auto;}
    .chip{padding:6px 8px;border-radius:999px;font-size:13px;background:var(--chip-bg);color:var(--info);display:inline-flex;align-items:center;}
    .chip.small{padding:4px 6px;font-size:12px;}
    .badge{padding:6px 8px;border-radius:8px;font-size:12px;color:white;}
    .badge.available{background:var(--success);}
    .badge.onhand{background:var(--info);}
    .badge.allocated{background:var(--warning);}
    .badge.onorder{background:#64748b;}
    .actions{display:flex;gap:8px;margin-left:10px;}
    .action{padding:6px 8px;border-radius:8px;border:1px solid #e6eefc;background:#fff;cursor:pointer;font-size:13px;}
    .action.primary{background:var(--accent);color:white;border:none;}
    .expand{font-size:13px;color:var(--muted);margin-left:8px;cursor:pointer;}
    .small{font-size:13px;color:var(--muted);}
    .box-card{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:#fff;margin-bottom:8px;border:1px solid #eef2ff;}
    .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:99;}
    .modal .panel{width:92%;max-width:720px;background:#fff;padding:16px;border-radius:10px;}
    .field{display:flex;flex-direction:column;margin:8px 0;}
    input[type="text"], input[type="number"], textarea, select{padding:8px;border-radius:8px;border:1px solid #e6eefc;font-size:14px;}
    .row-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;color:#fff;padding:12px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.2);}
    .muted{color:var(--muted);}
    .pending-dot{width:9px;height:9px;background:#f59e0b;border-radius:99px;display:inline-block;margin-left:8px;}
    .tag{background:#eef2ff;padding:6px 8px;border-radius:8px;color:var(--info);font-weight:600;}
    .flex{display:flex;gap:8px;align-items:center;}
    .link{color:var(--accent);text-decoration:underline;cursor:pointer;font-size:13px;}
    footer{margin-top:18px;font-size:13px;color:var(--muted);text-align:center;}
    @media(max-width:640px){
      .row-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="tech">
        <div>
          <h1>Technician Van Stock — T1 (John Doe)</h1>
          <div class="meta">Tech ID: T1 • Location: Berlin</div>
        </div>
      </div>
      <div class="controls">
        <div class="meta" id="lastSync">Last sync: —</div>
        <button class="btn" id="syncBtn">Sync now</button>
        <button class="btn secondary" id="clearBtn">Reset Demo</button>
      </div>
    </header>

    <div class="tabs" role="tablist" aria-label="Main tabs">
      <div class="tab active" data-tab="van" id="tabVan">Van Stock</div>
      <div class="tab" data-tab="boxes" id="tabBoxes">Deliveries / Reception</div>
    </div>

    <div id="content">
      <!-- Van Stock View -->
      <div id="view-van">
        <div class="cards">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div class="muted">Total parts</div>
                <div style="font-size:20px;font-weight:700" id="totalParts">0</div>
              </div>
              <div style="text-align:right">
                <div class="muted">Items to receive</div>
                <div style="font-size:18px;font-weight:700" id="toReceiveCount">0</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="muted">Allocated</div>
            <div style="font-size:20px;font-weight:700" id="allocatedCount">0</div>
          </div>
          <div class="card">
            <div class="muted">Missing</div>
            <div style="font-size:20px;font-weight:700" id="missingCount">0</div>
          </div>
        </div>

        <div class="list" id="vanList">
          <!-- rows -->
        </div>
      </div>

      <!-- Boxes View -->
      <div id="view-boxes" style="display:none;">
        <div class="list" id="boxList">
          <!-- box rows -->
        </div>
      </div>
    </div>

    <footer>Mockup prototype — actions stored locally. Use <strong>Sync now</strong> to simulate sending changes.</footer>
  </div>

  <!-- Modal container -->
  <div id="modal" style="display:none;"></div>

  <!-- Toast -->
  <div id="toast" style="display:none;" class="toast">Saved</div>

<script>
/*
  Simple mockup JS for Van Stock and Delivery Reception.
  - Data stored in localStorage under "vanMockData"
  - Pending actions stored under "vanPending"
  - Sync simulates server processing: moves pending to synced and updates lastSync.
*/

// Sample data (initial)
const sampleData = {
  technician_id: "T1",
  parts: [
    {
      part_id: "P12345",
      description: 'Valve 3/4"',
      available_qty: 2,
      on_hand_qty: 1,
      allocated_qty: 1,
      on_order_qty: 0,
      expected_delivery_date: null,
      part_price: 12.5,
      status: "ON_HAND",
      linked_WOs: [{wo_id:"WO100",booking_date:"2026-05-20",requested_qty:1,consumed_qty:0}],
      delivery_box_ids: [{box_id:"BOX123",delivered_qty:1}],
      qc_photos: [],
      last_updated: new Date().toISOString(),
      pending_local_changes:false
    },
    {
      part_id: "P67890",
      description: "Filter",
      available_qty: 1,
      on_hand_qty: 0,
      allocated_qty: 0,
      on_order_qty: 1,
      expected_delivery_date: "2026-05-22",
      part_price: 7.25,
      status: "ON_ORDER",
      linked_WOs: [],
      delivery_box_ids: [],
      qc_photos: [],
      last_updated: new Date().toISOString(),
      pending_local_changes:false
    },
    {
      part_id: "P11111",
      description: "Hose connector",
      available_qty: 0,
      on_hand_qty: 0,
      allocated_qty: 2,
      on_order_qty: 0,
      expected_delivery_date: null,
      part_price: 5.5,
      status: "ALLOCATED",
      linked_WOs: [{wo_id:"WO200",booking_date:"2026-05-21",requested_qty:2,consumed_qty:0}],
      delivery_box_ids: [],
      qc_photos: [],
      last_updated: new Date().toISOString(),
      pending_local_changes:false
    }
  ],
  boxes: [
    {
      box_id:"BOX123",
      shipment_date:"2026-05-20T07:30:00Z",
      delivered_by:"Warehouse DE",
      status:"UNCONFIRMED",
      items:[
        {part_id:"P12345",description:'Valve 3/4"',wo_id:"WO100",requested_qty:1,delivered_qty:1},
        {part_id:"P67890",description:"Filter",wo_id:"WO101",requested_qty:1,delivered_qty:0}
      ]
    }
  ],
  missingReports: []
};

const LS_KEY = "vanMockData_v1";
const LS_PENDING = "vanMockPending_v1";

function loadData(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw) return JSON.parse(raw);
  localStorage.setItem(LS_KEY, JSON.stringify(sampleData));
  return JSON.parse(localStorage.getItem(LS_KEY));
}
function saveData(d){
  localStorage.setItem(LS_KEY, JSON.stringify(d));
}
function loadPending(){ return JSON.parse(localStorage.getItem(LS_PENDING) || "[]"); }
function savePending(p){ localStorage.setItem(LS_PENDING, JSON.stringify(p)); }

let state = loadData();
let pending = loadPending();

function render(){
  document.getElementById('lastSync').innerText = "Last sync: " + (localStorage.getItem('lastSync') || '—');
  renderCounts();
  renderVanList();
  renderBoxes();
}
function renderCounts(){
  const totalParts = state.parts.length;
  const toReceive = state.parts.filter(p=>p.status==='TO_BE_RECEIVED' || p.on_hand_qty>0).length;
  const allocated = state.parts.reduce((s,p)=>s+p.allocated_qty,0);
  const missing = state.missingReports.length;
  document.getElementById('totalParts').innerText = totalParts;
  document.getElementById('toReceiveCount').innerText = toReceive;
  document.getElementById('allocatedCount').innerText = allocated;
  document.getElementById('missingCount').innerText = missing;
}
function formatDateIso(d){
  if(!d) return '';
  const dt = new Date(d);
  return dt.toLocaleDateString();
}

function renderVanList(){
  const container = document.getElementById('vanList');
  container.innerHTML = '';
  state.parts.forEach(p=>{
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div style="min-width:180px;">
        <div class="part-id">${p.part_id}</div>
        <div class="desc">${p.description}</div>
        <div class="small">Price: €${p.part_price.toFixed(2)}</div>
      </div>
      <div class="qtys">
        <div class="chip small">Available: ${p.available_qty}</div>
        <div class="chip small" style="background:#e6f6ff;color:var(--info)">On hand: ${p.on_hand_qty}</div>
        <div class="chip small" style="background:#fff7ed;color:var(--warning)"><span style="color:var(--muted)">Allocated:</span> ${p.allocated_qty}</div>
        <div class="chip small" style="background:#f8fafc;color:var(--muted)">On order: ${p.on_order_qty}${p.expected_delivery_date? ' • ETA '+formatDateIso(p.expected_delivery_date):''}</div>
      </div>
      <div class="actions">
        <button class="action" data-act="details" data-id="${p.part_id}">Details</button>
        <button class="action primary" data-act="consume" data-id="${p.part_id}">Consume</button>
        <button class="action" data-act="receive" data-id="${p.part_id}">Receive</button>
        <button class="action" data-act="missing" data-id="${p.part_id}">Missing</button>
      </div>
    `;
    container.appendChild(row);
  });

  // attach handlers
  container.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = b.getAttribute('data-id');
      const act = b.getAttribute('data-act');
      if(act==='details') openDetails(id);
      if(act==='consume') consumePart(id);
      if(act==='receive') receivePart(id);
      if(act==='missing') markMissing(id);
    });
  });
}

function renderBoxes(){
  const container = document.getElementById('boxList');
  container.innerHTML = '';
  state.boxes.forEach(box=>{
    const el = document.createElement('div');
    el.className = 'box-card';
    el.innerHTML = `
      <div>
        <div style="font-weight:700">${box.box_id}</div>
        <div class="small muted">${box.delivered_by} • ${new Date(box.shipment_date).toLocaleString()}</div>
        <div class="small">Status: <span class="tag">${box.status}</span></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="small muted">${box.items.length} items</div>
        <button class="action" data-box="${box.box_id}" data-act="open">Open Box</button>
      </div>
    `;
    container.appendChild(el);
  });

  container.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', e=>{
      const boxId = b.getAttribute('data-box');
      openBox(boxId);
    });
  });
}

/* -- actions -- */
function findPart(part_id){ return state.parts.find(p=>p.part_id===part_id); }

function pushPending(actionType, payload){
  const entry = {id: 'p-'+Date.now()+'-'+Math.floor(Math.random()*999), actionType, payload, timestamp:new Date().toISOString()};
  pending.push(entry);
  savePending(pending);
  showToast('Queued: '+actionType);
  // mark local item pending
  if(payload.part_id){
    const it = findPart(payload.part_id);
    if(it){ it.pending_local_changes = true; it.last_updated = new Date().toISOString(); saveData(state); render(); }
  }
}

function consumePart(part_id){
  const part = findPart(part_id);
  if(!part) return alert('Part not found');
  const qty = 1;
  if(part.available_qty < qty){ return alert('Not enough quantity to consume'); }
  // local update
  part.available_qty -= qty;
  part.linked_WOs = part.linked_WOs || [];
  const targetWO = part.linked_WOs[0] || {wo_id:'WO-Manual', booking_date:null, requested_qty:0, consumed_qty:0};
  targetWO.consumed_qty = (targetWO.consumed_qty||0) + qty;
  part.status = 'CONSUMED';
  part.last_updated = new Date().toISOString();
  saveData(state);
  pushPending('CONSUME',{part_id, qty, wo:targetWO.wo_id});
  render();
}

function receivePart(part_id){
  const part = findPart(part_id);
  if(!part) return;
  part.on_hand_qty = Math.max(0, (part.on_hand_qty||0));
  part.available_qty = (part.available_qty||0) + 1;
  part.status = 'ON_HAND';
  part.last_updated = new Date().toISOString();
  saveData(state);
  pushPending('RECEIVE',{part_id, qty:1});
  render();
}

function markMissing(part_id){
  const reason = prompt('Optional note for missing item:','Not in box');
  const photo = prompt('Optional photo URL (for demo):','');
  const part = findPart(part_id);
  if(!part) return;
  // create missing report
  const report = {id:'m-'+Date.now(), part_id, technician_id:state.technician_id, note:reason, photo:photo||null, timestamp:new Date().toISOString()};
  state.missingReports.push(report);
  part.status = 'MISSING';
  part.last_updated = new Date().toISOString();
  saveData(state);
  pushPending('MISSING',{part_id, note:reason, photo});
  render();
  showToast('Missing reported');
}

function openDetails(part_id){
  const part = findPart(part_id);
  if(!part) return;
  const html = document.createElement('div');
  html.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div><strong>${part.part_id}</strong> • ${part.description}</div>
      <div><button class="action" id="closeModal">Close</button></div>
    </div>
    <div class="row-grid">
      <div>
        <div class="small muted">Available</div><div style="font-size:18px">${part.available_qty}</div>
        <div class="small muted" style="margin-top:8px">On hand</div><div style="font-size:16px">${part.on_hand_qty}</div>
        <div class="small muted" style="margin-top:8px">Allocated</div><div style="font-size:16px">${part.allocated_qty}</div>
      </div>
      <div>
        <div class="small muted">On order</div><div style="font-size:16px">${part.on_order_qty}${part.expected_delivery_date? ' • ETA '+formatDateIso(part.expected_delivery_date):''}</div>
        <div class="small muted" style="margin-top:8px">Price</div><div style="font-size:16px">€${part.part_price.toFixed(2)}</div>
        <div style="margin-top:12px"><strong>Linked WOs</strong></div>
        <div class="small">${part.linked_WOs.map(w=>w.wo_id+' ('+w.booking_date+')').join(', ') || '—'}</div>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button class="btn" id="doConsume">Consume</button>
      <button class="btn secondary" id="doReceive">Receive</button>
      <button class="btn secondary" id="doMissing">Mark Missing</button>
    </div>
  `;
  showModal(html);
  document.getElementById('closeModal').addEventListener('click', hideModal);
  document.getElementById('doConsume').addEventListener('click', ()=>{
    consumePart(part_id); hideModal();
  });
  document.getElementById('doReceive').addEventListener('click', ()=>{ receivePart(part_id); hideModal(); });
  document.getElementById('doMissing').addEventListener('click', ()=>{ markMissing(part_id); hideModal(); });
}

/* Box flows */
function openBox(boxId){
  const box = state.boxes.find(b=>b.box_id===boxId);
  if(!box) return;
  const panel = document.createElement('div');
  const listHtml = box.items.map(it=>{
    const status = it.delivered_qty > 0 ? 'ON_HAND' : 'TO_BE_RECEIVED';
    return `
      <div style="padding:8px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div><strong>${it.part_id}</strong> • ${it.description}</div>
          <div class="small muted">WO ${it.wo_id} • Requested ${it.requested_qty} • Delivered ${it.delivered_qty}</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="action" data-act="receive" data-part="${it.part_id}" data-box="${boxId}">Receive</button>
          <button class="action" data-act="missing" data-part="${it.part_id}" data-box="${boxId}">Missing</button>
          <button class="action" data-act="damage" data-part="${it.part_id}" data-box="${boxId}">Damaged</button>
        </div>
      </div>
    `;
  }).join('');
  panel.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div>
        <div style="font-weight:700">${box.box_id}</div>
        <div class="small muted">${box.delivered_by} • ${new Date(box.shipment_date).toLocaleString()}</div>
      </div>
      <div>
        <button class="action" id="confirmBox">Confirm box received</button>
        <button class="action" id="closeBox">Close</button>
      </div>
    </div>
    <div>${listHtml}</div>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button class="btn" id="receiveAll">Receive all</button>
      <button class="btn secondary" id="markMissingAll">Mark all missing</button>
    </div>
  `;
  showModal(panel);
  // handlers
  panel.querySelectorAll('button[data-act]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const act = b.getAttribute('data-act');
      const part = b.getAttribute('data-part');
      if(act==='receive'){ receiveFromBox(part, box.box_id); }
      if(act==='missing'){ markMissingFromBox(part, box.box_id); }
      if(act==='damage'){ reportDamageFromBox(part, box.box_id); }
      // re-render modal content by closing and reopening (simpler)
      hideModal();
      openBox(boxId);
    });
  });
  document.getElementById('confirmBox').addEventListener('click', ()=>{
    confirmBox(box.box_id);
    hideModal();
  });
  document.getElementById('closeBox').addEventListener('click', hideModal);
  document.getElementById('receiveAll').addEventListener('click', ()=>{
    box.items.forEach(it=>{ if(it.delivered_qty>0) receiveFromBox(it.part_id, box.box_id); });
    hideModal(); render();
  });
  document.getElementById('markMissingAll').addEventListener('click', ()=>{
    box.items.forEach(it=>{ if(it.delivered_qty===0) markMissingFromBox(it.part_id, box.box_id); });
    hideModal(); render();
  });
}

function receiveFromBox(part_id, box_id){
  const part = findPart(part_id);
  if(!part){
    // part not in van stock: add it
    state.parts.push({
      part_id, description:'(from box)', available_qty:1, on_hand_qty:1, allocated_qty:0, on_order_qty:0,
      expected_delivery_date:null, part_price:0, status:'ON_HAND', linked_WOs:[], delivery_box_ids:[{box_id,delivered_qty:1}],
      qc_photos:[], last_updated:new Date().toISOString(), pending_local_changes:false
    });
  } else {
    part.available_qty = (part.available_qty||0) + 1;
    part.on_hand_qty = (part.on_hand_qty||0) + 1;
    part.delivery_box_ids = part.delivery_box_ids || [];
    part.delivery_box_ids.push({box_id, delivered_qty:1});
    part.status = 'ON_HAND';
    part.last_updated = new Date().toISOString();
  }
  saveData(state);
  pushPending('RECEIVE_FROM_BOX',{part_id, box_id, qty:1});
  render();
}

function markMissingFromBox(part_id, box_id){
  markMissing(part_id);
  pushPending('MISSING_FROM_BOX',{part_id,box_id});
}

function reportDamageFromBox(part_id, box_id){
  const url = prompt('Photo URL for damage (demo):','');
  const part = findPart(part_id);
  if(!part) return;
  part.status = 'DAMAGED';
  part.qc_photos = part.qc_photos || [];
  if(url) part.qc_photos.push(url);
  part.last_updated = new Date().toISOString();
  saveData(state);
  pushPending('DAMAGED',{part_id,box_id,photo:url});
  render();
}

function confirmBox(boxId){
  const box = state.boxes.find(b=>b.box_id===boxId);
  if(!box) return;
  box.status = 'CONFIRMED';
  box.confirmed_at = new Date().toISOString();
  saveData(state);
  pushPending('CONFIRM_BOX',{boxId});
  showToast('Box confirmed');
  render();
}

/* modal helpers */
function showModal(content){
  const modal = document.getElementById('modal');
  modal.innerHTML = '<div class="modal"><div class="panel" id="modalPanel"></div></div>';
  document.getElementById('modalPanel').appendChild(content);
  modal.style.display = 'block';
}
function hideModal(){
  const modal = document.getElementById('modal');
  modal.style.display = 'none';
  modal.innerHTML = '';
}

/* toast */
let toastTimer=null;
function showToast(msg){
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.display = 'none'; },3000);
}

/* Sync simulation */
document.getElementById('syncBtn').addEventListener('click', ()=>{
  // simulate API call and success
  if(pending.length===0){ localStorage.setItem('lastSync', new Date().toLocaleString()); render(); showToast('Already up to date'); return; }
  showToast('Syncing...');
  setTimeout(()=>{
    // mark all pending as processed
    pending.forEach(entry=>{
      // basic simulation: mark pending_local_changes false for involved parts
      if(entry.payload && entry.payload.part_id){
        const p = findPart(entry.payload.part_id);
        if(p) p.pending_local_changes = false;
      }
    });
    pending = [];
    savePending(pending);
    localStorage.setItem('lastSync', new Date().toLocaleString());
    render();
    showToast('Sync complete');
  },900);
});

/* Reset demo */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!confirm('Reset demo data?')) return;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_PENDING);
  state = loadData();
  pending = loadPending();
  localStorage.removeItem('lastSync');
  render();
});

/* Tabs */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.getAttribute('data-tab');
    document.getElementById('view-van').style.display = tab==='van' ? '' : 'none';
    document.getElementById('view-boxes').style.display = tab==='boxes' ? '' : 'none';
  });
});

/* init */
render();

</script>
</body>
</html>
