<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Field Service Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            /* Fluent Design Color Palette */
            --primary-color: #0078d4;
            --primary-dark: #106ebe;
            --primary-light: #2b88d8;
            --success-color: #107c10;
            --warning-color: #ffaa44;
            --error-color: #d13438;
            --surface: #ffffff;
            --background: #f3f2f1;
            --text-primary: #323130;
            --text-secondary: #605e5c;
            --text-tertiary: #8a8886;
            --border-color: #edebe9;
            --divider: #e1dfdd;
            
            /* Elevation Shadows (Fluent) */
            --shadow-2: 0 0.3px 0.9px rgba(0,0,0,0.1), 0 1.6px 3.6px rgba(0,0,0,0.13);
            --shadow-4: 0 1.6px 3.6px rgba(0,0,0,0.13), 0 3.2px 7.2px rgba(0,0,0,0.13);
            --shadow-8: 0 3.2px 7.2px rgba(0,0,0,0.13), 0 6.4px 14.4px rgba(0,0,0,0.13);
            --shadow-16: 0 6.4px 14.4px rgba(0,0,0,0.13), 0 12.8px 28.8px rgba(0,0,0,0.13);
            
            /* Spacing System */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            --space-2xl: 32px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 999px;
            
            /* Typography */
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
        }
        
        body {
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* ========================================
           HEADER - Dynamics 365 Style
        ======================================== */
        header {
            background: var(--primary-color);
            color: white;
            padding: 0;
            box-shadow: var(--shadow-4);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            padding: var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .app-icon {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .header-title h1 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-actions {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }

        .pending-badge {
            background: var(--error-color);
            color: white;
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 700;
            min-width: 24px;
            text-align: center;
            box-shadow: var(--shadow-2);
        }

        .icon-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-button:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }

        /* ========================================
           NAVIGATION - Modern Tab Bar
        ======================================== */
        .tabs {
            display: flex;
            background: var(--surface);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: var(--space-lg);
            text-align: center;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .tab::before {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab.active {
            color: var(--primary-color);
        }

        .tab.active::before {
            transform: scaleX(1);
        }

        .tab-icon {
            font-size: var(--font-size-xl);
        }

        /* ========================================
           SEARCH & FILTER
        ======================================== */
        .search-container {
            padding: var(--space-lg);
            background: var(--surface);
            border-bottom: 1px solid var(--border-color);
        }

        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .search-icon {
            position: absolute;
            left: var(--space-md);
            color: var(--text-tertiary);
            font-size: var(--font-size-lg);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: var(--space-md) var(--space-md) var(--space-md) 44px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            background: var(--background);
            transition: all 0.2s;
            height: 44px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--surface);
            box-shadow: var(--shadow-2);
        }

        /* FILTER CHIPS */
        .filter-chips {
            display: flex;
            gap: var(--space-sm);
            overflow-x: auto;
            padding-bottom: var(--space-xs);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: var(--space-sm) var(--space-lg);
            background: var(--background);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .filter-chip:hover {
            background: var(--surface);
            border-color: var(--primary-light);
        }

        .filter-chip.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .filter-chip-icon {
            font-size: var(--font-size-base);
        }

        /* ========================================
           PAGE CONTENT
        ======================================== */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-content {
            padding: var(--space-lg);
        }

        /* ========================================
           CARDS - Material Design Inspired
        ======================================== */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-2);
            margin-bottom: var(--space-md);
            overflow: hidden;
            transition: all 0.2s;
        }

        .card:active {
            transform: scale(0.98);
            box-shadow: var(--shadow-4);
        }

        .card-header {
            padding: var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--border-color);
        }

        .card-body {
            padding: var(--space-lg);
        }

        /* ========================================
           PART ITEMS - Enhanced Cards
        ======================================== */
        .part-item {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-2);
            margin-bottom: var(--space-md);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
        }

        .part-item:hover {
            box-shadow: var(--shadow-4);
            transform: translateY(-2px);
        }

        .part-item:active {
            transform: translateY(0);
            box-shadow: var(--shadow-2);
        }

        .part-content {
            padding: var(--space-lg);
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }

        .part-id {
            font-weight: 700;
            font-size: var(--font-size-lg);
            color: var(--text-primary);
            letter-spacing: -0.2px;
        }

        .part-status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--success-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            font-weight: 700;
        }

        .part-desc {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            line-height: 1.5;
        }

        /* PRICE BADGE */
        .part-price {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            background: linear-gradient(135deg, #107c10 0%, #0d6b0d 100%);
            color: white;
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: 700;
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-2);
        }

        .chips-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }

        .chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            border: 1px solid;
        }

        .chip-label {
            font-size: var(--font-size-xs);
            font-weight: 500;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .chip-value {
            font-size: var(--font-size-lg);
            font-weight: 700;
        }

        .chip-available {
            background: #f3fff3;
            color: var(--success-color);
            border-color: #d4edda;
        }

        .chip-onhand {
            background: #f0f6ff;
            color: var(--primary-color);
            border-color: #cfe4ff;
        }

        .chip-allocated {
            background: #fff8e6;
            color: #8a5c00;
            border-color: #ffe69c;
        }

        .chip-onorder {
            background: #f8f8f8;
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        /* ========================================
           RECEPTION - Enhanced Input Section
        ======================================== */
        .box-input-section {
            background: var(--surface);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            margin: var(--space-lg);
            box-shadow: var(--shadow-2);
        }

        .section-title {
            font-size: var(--font-size-base);
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .section-icon {
            width: 20px;
            height: 20px;
            color: var(--primary-color);
        }

        .box-input-group {
            display: flex;
            gap: var(--space-sm);
        }

        .box-input {
            flex: 1;
            padding: var(--space-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            height: 48px;
            transition: all 0.2s;
        }

        .box-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-2);
        }

        /* ========================================
           BUTTONS - Fluent Design
        ======================================== */
        .btn {
            padding: var(--space-md) var(--space-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            letter-spacing: 0.2px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-2);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            box-shadow: var(--shadow-4);
            transform: translateY(-1px);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: var(--shadow-2);
        }

        .btn-primary:disabled {
            background: var(--border-color);
            color: var(--text-tertiary);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            width: calc(100% - 32px);
            margin: var(--space-lg);
            padding: var(--space-lg);
            font-size: var(--font-size-lg);
            box-shadow: var(--shadow-4);
            min-height: 56px;
        }

        .btn-success:hover:not(:disabled) {
            background: #0d6b0d;
            box-shadow: var(--shadow-8);
        }

        .btn-success:disabled {
            background: var(--border-color);
            color: var(--text-tertiary);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* FAB - Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: var(--shadow-8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 90;
        }

        .fab:hover {
            box-shadow: var(--shadow-16);
            transform: scale(1.1);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* ========================================
           MODAL - Bottom Sheet Style
        ======================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: flex-end;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeInOverlay 0.3s ease-out;
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--surface);
            width: 100%;
            max-height: 85vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-16);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-handle {
            width: 36px;
            height: 4px;
            background: var(--border-color);
            border-radius: var(--radius-full);
            margin: var(--space-sm) auto;
        }

        .modal-header {
            padding: var(--space-md) var(--space-lg) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--background);
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .modal-close {
            background: var(--background);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 24px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--border-color);
        }

        .modal-close:active {
            transform: scale(0.9);
        }

        .modal-body {
            padding: var(--space-lg);
            overflow-y: auto;
            flex: 1;
        }

        /* ========================================
           DETAIL SECTIONS
        ======================================== */
        .detail-section {
            margin-bottom: var(--space-xl);
        }

        .detail-section h4 {
            font-size: var(--font-size-sm);
            font-weight: 700;
            color: var(--text-tertiary);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .detail-value {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            padding: var(--space-md) 0;
            line-height: 1.6;
        }

        .price-info {
            background: linear-gradient(135deg, #f0f6ff 0%, #e8f4fd 100%);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
            margin-bottom: var(--space-xl);
        }

        .price-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .price-amount {
            font-size: var(--font-size-2xl);
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .wo-list {
            list-style: none;
        }

        .wo-item {
            padding: var(--space-md);
            background: var(--background);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            border-left: 3px solid var(--primary-color);
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wo-item:hover {
            background: #e8f4fd;
            transform: translateX(4px);
        }

        .wo-info {
            flex: 1;
        }

        .wo-id {
            font-weight: 700;
            color: var(--primary-color);
            font-size: var(--font-size-base);
        }

        .wo-date {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-top: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .wo-qty {
            background: var(--primary-color);
            color: white;
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: 700;
            min-width: 50px;
            text-align: center;
        }

        /* ========================================
           ITEM LIST - Enhanced
        ======================================== */
        .item-list {
            list-style: none;
        }

        .item-row {
            padding: var(--space-lg);
            background: var(--background);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-md);
            border: 2px solid var(--border-color);
            transition: all 0.2s;
        }

        .item-row:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-2);
        }

        .item-row.manual {
            border-left: 4px solid var(--primary-color);
            background: #f0f6ff;
        }

        .item-info {
            margin-bottom: var(--space-md);
        }

        .item-part-id {
            font-weight: 700;
            font-size: var(--font-size-lg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .item-desc {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-top: var(--space-xs);
            line-height: 1.5;
        }

        .item-wo {
            font-size: var(--font-size-sm);
            color: var(--primary-color);
            margin-top: var(--space-sm);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .item-actions {
            display: flex;
            gap: var(--space-lg);
            align-items: center;
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            cursor: pointer;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            transition: all 0.2s;
            min-height: 44px;
        }

        .checkbox-group:hover {
            background: rgba(0,120,212,0.05);
        }

        .checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .checkbox-group label {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 500;
        }

        .photo-upload {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: var(--surface);
            border-radius: var(--radius-md);
            border: 2px dashed var(--border-color);
        }

        .photo-upload input[type="file"] {
            font-size: var(--font-size-sm);
            flex: 1;
        }

        .photo-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-2);
        }

        .manual-tag {
            background: var(--primary-color);
            color: white;
            font-size: var(--font-size-xs);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-full);
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .btn-add-manual {
            background: var(--surface);
            color: var(--primary-color);
            border: 2px dashed var(--primary-color);
            width: 100%;
            padding: var(--space-lg);
            margin-top: var(--space-md);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .btn-add-manual:hover {
            background: #f0f6ff;
            border-style: solid;
        }

        /* ========================================
           FORM ELEMENTS
        ======================================== */
        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-group label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: all 0.2s;
            min-height: 44px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,120,212,0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ========================================
           SNACKBAR - Material Design
        ======================================== */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-16);
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90%;
        }

        .snackbar.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .snackbar-message {
            font-size: var(--font-size-base);
            font-weight: 500;
        }

        .btn-undo {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-undo:hover {
            background: var(--primary-light);
        }

        .btn-undo:active {
            transform: scale(0.95);
        }

        /* ========================================
           EMPTY STATE
        ======================================== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--space-lg);
            opacity: 0.3;
        }

        .empty-state p {
            font-size: var(--font-size-base);
            color: var(--text-tertiary);
        }

        /* ========================================
           ALERT
        ======================================== */
        .alert {
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            font-size: var(--font-size-sm);
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            line-height: 1.5;
        }

        .alert-icon {
            font-size: var(--font-size-xl);
            flex-shrink: 0;
        }

        .alert-error {
            background: #fde7e9;
            color: var(--error-color);
            border-left: 4px solid var(--error-color);
        }

        .alert-success {
            background: #dff6dd;
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-warning {
            background: #fff8e6;
            color: #8a5c00;
            border-left: 4px solid var(--warning-color);
        }

        /* ========================================
           LOADING SPINNER
        ======================================== */
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: var(--space-2xl) auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           RESPONSIVE
        ======================================== */
        @media (min-width: 768px) {
            .modal {
                max-width: 600px;
                margin: 0 auto;
                border-radius: var(--radius-lg);
                max-height: 90vh;
            }
            
            .chips-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ========================================
           ACCESSIBILITY
        ======================================== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }

        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="header-title">
                <div class="app-icon">‚öôÔ∏è</div>
                <h1>Field Service</h1>
            </div>
            <div class="header-actions">
                <div class="pending-badge" id="pendingBadge">0</div>
                <button class="icon-button" aria-label="Sync">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M4 10a6 6 0 1 1 0 .01L4 10zm6-8a8 8 0 1 0 0 16 8 8 0 0 0 0-16z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('vanStock', event)">
            <span class="tab-icon">üì¶</span>
            Van Stock
        </button>
        <button class="tab" onclick="switchTab('reception', event)">
            <span class="tab-icon">üì•</span>
            Reception
        </button>
    </div>

    <!-- Van Stock Page -->
    <div id="vanStockPage" class="page active">
        <div class="search-container">
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search parts by ID or description..." id="vanSearchInput" aria-label="Search parts">
            </div>
            <!-- FILTER CHIPS -->
            <div class="filter-chips">
                <div class="filter-chip active" onclick="setFilter('all')">
                    <span class="filter-chip-icon">üì¶</span>
                    All Parts
                </div>
                <div class="filter-chip" onclick="setFilter('available')">
                    <span class="filter-chip-icon">‚úÖ</span>
                    Available
                </div>
                <div class="filter-chip" onclick="setFilter('onhand')">
                    <span class="filter-chip-icon">üì¶</span>
                    On Hand
                </div>
                <div class="filter-chip" onclick="setFilter('allocated')">
                    <span class="filter-chip-icon">üîí</span>
                    Allocated
                </div>
                <div class="filter-chip" onclick="setFilter('onorder')">
                    <span class="filter-chip-icon">üöö</span>
                    On Order
                </div>
            </div>
        </div>
        <div class="page-content" id="partListContainer"></div>
    </div>

    <!-- Reception Page -->
    <div id="receptionPage" class="page">
        <div class="box-input-section">
            <h3 class="section-title">
                <span class="section-icon">üì¶</span>
                Scan or Enter Box ID
            </h3>
            <div class="box-input-group">
                <input type="text" class="box-input" placeholder="BOX123" id="boxIdInput" aria-label="Box ID">
                <button class="btn btn-primary" onclick="confirmBox()">
                    ‚úì Confirm
                </button>
            </div>
        </div>
        <div id="receptionContent"></div>
        <button class="btn btn-success" id="submitReceptionBtn" disabled onclick="submitReception()">
            <span>‚úì</span> Submit Reception
        </button>
    </div>

    <!-- Part Details Modal -->
    <div class="modal-overlay" id="partDetailsModal" role="dialog" aria-modal="true" aria-labelledby="partDetailsTitle">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h2 class="modal-title" id="partDetailsTitle">Part Details</h2>
                <button class="modal-close" onclick="closeModal('partDetailsModal')" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body" id="partDetailsBody"></div>
        </div>
    </div>

    <!-- Box Contents Modal -->
    <div class="modal-overlay" id="boxContentsModal" role="dialog" aria-modal="true" aria-labelledby="boxContentsTitle">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h2 class="modal-title" id="boxContentsTitle">Box Contents</h2>
                <button class="modal-close" onclick="closeModal('boxContentsModal')" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body" id="boxContentsBody"></div>
        </div>
    </div>

    <!-- Manual Add Item Modal -->
    <div class="modal-overlay" id="manualAddModal" role="dialog" aria-modal="true" aria-labelledby="manualAddTitle">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h2 class="modal-title" id="manualAddTitle">Add Manual Item</h2>
                <button class="modal-close" onclick="closeModal('manualAddModal')" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <form id="manualAddForm" onsubmit="submitManualItem(event)">
                    <div class="form-group">
                        <label for="manualPartId">Part ID *</label>
                        <input type="text" id="manualPartId" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="manualDescription">Description *</label>
                        <input type="text" id="manualDescription" required>
                    </div>
                    <div class="form-group">
                        <label for="manualQty">Quantity *</label>
                        <input type="number" id="manualQty" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="manualNote">Note (Optional)</label>
                        <textarea id="manualNote" placeholder="Add any additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span>+</span> Add Item
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Missing Confirmation Modal -->
    <div class="modal-overlay" id="missingConfirmModal" role="dialog" aria-modal="true" aria-labelledby="missingConfirmTitle">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h2 class="modal-title" id="missingConfirmTitle">Confirm Missing Item</h2>
                <button class="modal-close" onclick="closeModal('missingConfirmModal')" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div>
                        Mark item <strong id="missingItemName"></strong> as missing?
                    </div>
                </div>
                <div class="form-group">
                    <label for="missingNote">Notes (Optional)</label>
                    <textarea id="missingNote" placeholder="Add any additional notes about why this item is missing..."></textarea>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="confirmMissing()">
                    ‚úì Confirm Missing
                </button>
            </div>
        </div>
    </div>

    <!-- Snackbar -->
    <div class="snackbar" id="snackbar">
        <span class="snackbar-message" id="snackbarMessage"></span>
        <button class="btn-undo" id="undoBtn">UNDO</button>
    </div>

    <script>
        // ========================================
        // DATA STORE - REALISTIC QUANTITIES
        // ========================================
        
        const PARTS_DATA = [
            {
                id: '00248240',
                description: 'Cable Assembly - Power Distribution',
                price: 245.50,
                available: 12,
                onHand: 15,
                allocated: 3,
                onOrder: 25,
                availableWOs: [
                    { woId: 'WO-2024-001', bookingDate: '2024-01-15', qty: 7 },
                    { woId: 'WO-2024-003', bookingDate: '2024-01-18', qty: 5 }
                ],
                onHandWOs: [
                    { woId: 'WO-2024-001', bookingDate: '2024-01-15', qty: 7 },
                    { woId: 'WO-2024-003', bookingDate: '2024-01-18', qty: 5 },
                    { woId: 'WO-2024-007', bookingDate: '2024-01-22', qty: 3 }
                ],
                allocatedWOs: [
                    { woId: 'WO-2024-002', bookingDate: '2024-01-16', qty: 3 }
                ],
                onOrderDetails: { qty: 25, eta: '2024-02-10' }
            },
            {
                id: '0008045',
                description: 'Electric Motor 3-Phase 5HP',
                price: 1850.00,
                available: 4,
                onHand: 6,
                allocated: 2,
                onOrder: 10,
                availableWOs: [
                    { woId: 'WO-2024-005', bookingDate: '2024-01-20', qty: 2 },
                    { woId: 'WO-2024-011', bookingDate: '2024-01-27', qty: 2 }
                ],
                onHandWOs: [
                    { woId: 'WO-2024-005', bookingDate: '2024-01-20', qty: 2 },
                    { woId: 'WO-2024-009', bookingDate: '2024-01-25', qty: 2 },
                    { woId: 'WO-2024-011', bookingDate: '2024-01-27', qty: 2 }
                ],
                allocatedWOs: [
                    { woId: 'WO-2024-006', bookingDate: '2024-01-21', qty: 2 }
                ],
                onOrderDetails: { qty: 10, eta: '2024-02-05' }
            },
            {
                id: '00169216',
                description: 'Cooling Fan Assembly 12V',
                price: 89.99,
                available: 8,
                onHand: 8,
                allocated: 0,
                onOrder: 0,
                availableWOs: [],
                onHandWOs: [],
                allocatedWOs: [],
                onOrderDetails: null
            },
            {
                id: '00452301',
                description: 'Hydraulic Pump HP-200',
                price: 3200.00,
                available: 0,
                onHand: 5,
                allocated: 5,
                onOrder: 15,
                availableWOs: [],
                onHandWOs: [
                    { woId: 'WO-2024-012', bookingDate: '2024-01-28', qty: 3 },
                    { woId: 'WO-2024-014', bookingDate: '2024-01-30', qty: 2 }
                ],
                allocatedWOs: [
                    { woId: 'WO-2024-011', bookingDate: '2024-01-27', qty: 3 },
                    { woId: 'WO-2024-013', bookingDate: '2024-01-29', qty: 2 }
                ],
                onOrderDetails: { qty: 15, eta: '2024-02-15' }
            },
            {
                id: '00567890',
                description: 'Bearing Kit Standard Heavy Duty',
                price: 156.75,
                available: 0,
                onHand: 0,
                allocated: 0,
                onOrder: 20,
                availableWOs: [],
                onHandWOs: [],
                allocatedWOs: [],
                onOrderDetails: { qty: 20, eta: '2024-02-20' }
            }
        ];

        const BOX_DATA = {
            'BOX123': {
                id: 'BOX123',
                items: [
                    { partId: '00248240', description: 'Cable Assembly - Power Distribution', woId: 'WO-2024-001', requested: 5, delivered: 5 },
                    { partId: '0008045', description: 'Electric Motor 3-Phase 5HP', woId: 'WO-2024-005', requested: 2, delivered: 1 },
                    { partId: '00169216', description: 'Cooling Fan Assembly 12V', woId: null, requested: 3, delivered: 3 }
                ]
            },
            'BOX456': {
                id: 'BOX456',
                items: [
                    { partId: '00452301', description: 'Hydraulic Pump HP-200', woId: 'WO-2024-012', requested: 1, delivered: 1 }
                ]
            }
        };

        let currentTab = 'vanStock';
        let currentFilter = 'all'; // NEW: Filter state
        let searchTerm = '';
        let filteredParts = [...PARTS_DATA];
        let currentBoxId = null;
        let boxItems = [];
        let pendingQueue = JSON.parse(localStorage.getItem('pendingQueue') || '[]');
        let lastAction = null;
        let snackbarTimeout = null;
        let searchDebounce = null;
        let currentMissingItem = null;

        function init() {
            renderPartList();
            updatePendingBadge();
            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('vanSearchInput').addEventListener('input', (e) => {
                clearTimeout(searchDebounce);
                searchDebounce = setTimeout(() => {
                    searchTerm = e.target.value;
                    applyFilters();
                }, 300);
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(overlay.id);
                    }
                });
            });
        }

        function switchTab(tab, event) {
            currentTab = tab;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            event.target.closest('.tab').classList.add('active');
            document.getElementById(tab + 'Page').classList.add('active');
        }

        // ========================================
        // NEW: FILTER FUNCTIONALITY
        // ========================================
        
        function setFilter(filter) {
            currentFilter = filter;
            
            // Update UI
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.closest('.filter-chip').classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            let result = [...PARTS_DATA];
            
            // Apply search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                result = result.filter(p => 
                    p.id.toLowerCase().includes(term) || 
                    p.description.toLowerCase().includes(term)
                );
            }
            
            // Apply quantity filter
            switch(currentFilter) {
                case 'available':
                    result = result.filter(p => p.available > 0);
                    break;
                case 'onhand':
                    result = result.filter(p => p.onHand > 0);
                    break;
                case 'allocated':
                    result = result.filter(p => p.allocated > 0);
                    break;
                case 'onorder':
                    result = result.filter(p => p.onOrder > 0);
                    break;
                case 'all':
                default:
                    // No additional filter
                    break;
            }
            
            filteredParts = result;
            renderPartList();
        }

        function renderPartList() {
            const container = document.getElementById('partListContainer');
            
            if (filteredParts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p>No parts found</p>
                    </div>
                `;
                return;
            }

            const html = filteredParts.map(part => `
                <div class="part-item" onclick="openPartDetails('${part.id}')">
                    <div class="part-content">
                        <div class="part-header">
                            <div class="part-id">${part.id}</div>
                            <div class="part-status-icon">‚úì</div>
                        </div>
                        <div class="part-desc">${part.description}</div>
                        <div class="part-price">üí∞ $${part.price.toFixed(2)}</div>
                        <div class="chips-container">
                            <div class="chip chip-available">
                                <span class="chip-label">Available</span>
                                <span class="chip-value">${part.available}</span>
                            </div>
                            <div class="chip chip-onhand">
                                <span class="chip-label">On Hand</span>
                                <span class="chip-value">${part.onHand}</span>
                            </div>
                            <div class="chip chip-allocated">
                                <span class="chip-label">Allocated</span>
                                <span class="chip-value">${part.allocated}</span>
                            </div>
                            <div class="chip chip-onorder">
                                <span class="chip-label">On Order</span>
                                <span class="chip-value">${part.onOrder}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function openPartDetails(partId) {
            const part = PARTS_DATA.find(p => p.id === partId);
            if (!part) return;

            document.getElementById('partDetailsTitle').textContent = `Part ${part.id}`;
            
            let bodyHtml = `
                <div class="price-info">
                    <div class="price-label">Unit Price</div>
                    <div class="price-amount">
                        üí∞ $${part.price.toFixed(2)}
                    </div>
                </div>

                <div class="detail-section">
                    <h4>üìã Description</h4>
                    <div class="detail-value">${part.description}</div>
                </div>
            `;

            // AVAILABLE Section with QUANTITIES
            if (part.available > 0) {
                bodyHtml += `
                    <div class="detail-section">
                        <h4>‚úÖ Available (${part.available} total)</h4>
                        ${part.availableWOs.length > 0 ? `
                            <ul class="wo-list">
                                ${part.availableWOs.map(wo => `
                                    <li class="wo-item">
                                        <div class="wo-info">
                                            <span class="wo-id">${wo.woId}</span>
                                            <div class="wo-date">üìÖ ${wo.bookingDate}</div>
                                        </div>
                                        <div class="wo-qty">${wo.qty} qty</div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<div class="detail-value">No linked work orders</div>'}
                    </div>
                `;
            }

            // ON HAND Section with QUANTITIES
            if (part.onHand > 0) {
                bodyHtml += `
                    <div class="detail-section">
                        <h4>üì¶ On Hand (${part.onHand} total)</h4>
                        ${part.onHandWOs.length > 0 ? `
                            <ul class="wo-list">
                                ${part.onHandWOs.map(wo => `
                                    <li class="wo-item">
                                        <div class="wo-info">
                                            <span class="wo-id">${wo.woId}</span>
                                            <div class="wo-date">üìÖ ${wo.bookingDate}</div>
                                        </div>
                                        <div class="wo-qty">${wo.qty} qty</div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<div class="detail-value">No linked work orders</div>'}
                    </div>
                `;
            }

            // ALLOCATED Section with QUANTITIES
            if (part.allocated > 0) {
                bodyHtml += `
                    <div class="detail-section">
                        <h4>üîí Allocated (${part.allocated} total)</h4>
                        ${part.allocatedWOs.length > 0 ? `
                            <ul class="wo-list">
                                ${part.allocatedWOs.map(wo => `
                                    <li class="wo-item">
                                        <div class="wo-info">
                                            <span class="wo-id">${wo.woId}</span>
                                            <div class="wo-date">üìÖ ${wo.bookingDate}</div>
                                        </div>
                                        <div class="wo-qty">${wo.qty} qty</div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<div class="detail-value">No linked work orders</div>'}
                    </div>
                `;
            }

            // ON ORDER Section
            if (part.onOrder > 0 && part.onOrderDetails) {
                bodyHtml += `
                    <div class="detail-section">
                        <h4>üöö On Order</h4>
                        <div class="detail-value">Quantity: ${part.onOrderDetails.qty}</div>
                        <div class="detail-value">ETA: ${part.onOrderDetails.eta}</div>
                    </div>
                `;
            }

            document.getElementById('partDetailsBody').innerHTML = bodyHtml;
            openModal('partDetailsModal');
        }

        function confirmBox() {
            const boxId = document.getElementById('boxIdInput').value.trim();
            
            if (!boxId) {
                alert('Please enter a Box ID');
                return;
            }

            const box = BOX_DATA[boxId];
            if (!box) {
                alert('Box not found: ' + boxId);
                return;
            }

            currentBoxId = boxId;
            boxItems = box.items.map((item, idx) => ({
                ...item,
                id: `ITEM-${Date.now()}-${idx}`,
                missing: false,
                damaged: false,
                photo: null,
                manual: false
            }));

            document.getElementById('submitReceptionBtn').disabled = false;
            openBoxContentsModal();
        }

        function openBoxContentsModal() {
            document.getElementById('boxContentsTitle').textContent = `Box ${currentBoxId}`;
            renderBoxContents();
            openModal('boxContentsModal');
        }

        function renderBoxContents() {
            const container = document.getElementById('boxContentsBody');
            
            let html = '<ul class="item-list">';
            
            boxItems.forEach(item => {
                html += `
                    <li class="item-row ${item.manual ? 'manual' : ''}">
                        <div class="item-info">
                            <div class="item-part-id">
                                ${item.partId}
                                ${item.manual ? '<span class="manual-tag">MANUAL</span>' : ''}
                            </div>
                            <div class="item-desc">${item.description}</div>
                            ${item.woId ? `<div class="item-wo">üîß WO: ${item.woId}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            <div class="checkbox-group">
                                <input type="checkbox" id="missing-${item.id}" 
                                       onchange="toggleMissing('${item.id}')" 
                                       ${item.missing ? 'checked' : ''}>
                                <label for="missing-${item.id}">Missing</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="damaged-${item.id}" 
                                       onchange="toggleDamaged('${item.id}')" 
                                       ${item.damaged ? 'checked' : ''}>
                                <label for="damaged-${item.id}">Damaged</label>
                            </div>
                        </div>
                        ${item.damaged ? `
                            <div class="photo-upload">
                                <input type="file" accept="image/*" 
                                       onchange="uploadDamagePhoto('${item.id}', event)" 
                                       id="photo-${item.id}">
                                ${item.photo ? `<img src="${item.photo}" class="photo-preview" alt="Damage">` : ''}
                            </div>
                        ` : ''}
                    </li>
                `;
            });
            
            html += '</ul>';
            html += '<button class="btn btn-add-manual" onclick="openManualAddModal()"><span>+</span> Add Manual Item</button>';
            
            container.innerHTML = html;
        }

        function toggleMissing(itemId) {
            const item = boxItems.find(i => i.id === itemId);
            if (!item) return;

            const checkbox = document.getElementById(`missing-${itemId}`);
            
            if (checkbox.checked) {
                currentMissingItem = itemId;
                document.getElementById('missingItemName').textContent = item.partId;
                document.getElementById('missingNote').value = '';
                openModal('missingConfirmModal');
            } else {
                item.missing = false;
                item.missingNote = null;
                showSnackbar(`${item.partId} unmarked as missing`, () => {
                    item.missing = true;
                    checkbox.checked = true;
                });
            }
        }

        function confirmMissing() {
            const note = document.getElementById('missingNote').value.trim();

            const item = boxItems.find(i => i.id === currentMissingItem);
            if (item) {
                item.missing = true;
                item.missingNote = note || 'No note provided';
                
                showSnackbar(`${item.partId} marked as missing`, () => {
                    item.missing = false;
                    item.missingNote = null;
                    document.getElementById(`missing-${item.id}`).checked = false;
                });
            }

            closeModal('missingConfirmModal');
            renderBoxContents();
        }

        function toggleDamaged(itemId) {
            const item = boxItems.find(i => i.id === itemId);
            if (!item) return;

            const checkbox = document.getElementById(`damaged-${itemId}`);
            
            if (checkbox.checked) {
                item.damaged = true;
                showSnackbar(`${item.partId} marked as damaged`, () => {
                    item.damaged = false;
                    item.photo = null;
                    checkbox.checked = false;
                    renderBoxContents();
                });
            } else {
                item.damaged = false;
                item.photo = null;
                showSnackbar(`${item.partId} unmarked as damaged`, () => {
                    item.damaged = true;
                    checkbox.checked = true;
                    renderBoxContents();
                });
            }
            
            renderBoxContents();
        }

        function uploadDamagePhoto(itemId, event) {
            const item = boxItems.find(i => i.id === itemId);
            if (!item) return;

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                item.photo = e.target.result;
                renderBoxContents();
            };
            reader.readAsDataURL(file);
        }

        function openManualAddModal() {
            openModal('manualAddModal');
        }

        function submitManualItem(event) {
            event.preventDefault();
            
            const partId = document.getElementById('manualPartId').value.trim();
            const description = document.getElementById('manualDescription').value.trim();
            const qty = parseInt(document.getElementById('manualQty').value);
            const note = document.getElementById('manualNote').value.trim();

            const newItem = {
                id: `MANUAL-${Date.now()}`,
                partId,
                description,
                qty,
                note,
                woId: null,
                manual: true,
                missing: false,
                damaged: false,
                photo: null
            };

            boxItems.push(newItem);
            
            showSnackbar(`Manual item ${partId} added`, () => {
                boxItems = boxItems.filter(i => i.id !== newItem.id);
                renderBoxContents();
            });

            document.getElementById('manualAddForm').reset();
            closeModal('manualAddModal');
            renderBoxContents();
        }

        function submitReception() {
            const damagedWithoutPhoto = boxItems.filter(i => i.damaged && !i.photo);
            
            if (damagedWithoutPhoto.length > 0) {
                alert('Photo required for damaged items: ' + damagedWithoutPhoto.map(i => i.partId).join(', '));
                return;
            }

            const received = boxItems.filter(i => !i.missing && !i.damaged);
            const missing = boxItems.filter(i => i.missing);
            const damaged = boxItems.filter(i => i.damaged);
            const manual = boxItems.filter(i => i.manual);

            const payload = {
                id: `DELCONF-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                timestamp: new Date().toISOString(),
                boxId: currentBoxId,
                received: received.map(i => ({ partId: i.partId, woId: i.woId })),
                missing: missing.map(i => ({ partId: i.partId, note: i.missingNote })),
                damaged: damaged.map(i => ({ partId: i.partId, photo: i.photo })),
                manual: manual.map(i => ({ partId: i.partId, description: i.description, qty: i.qty, note: i.note }))
            };

            pendingQueue.push(payload);
            localStorage.setItem('pendingQueue', JSON.stringify(pendingQueue));
            updatePendingBadge();

            showSnackbar(`Reception submitted for ${currentBoxId}`, () => {
                pendingQueue = pendingQueue.filter(p => p.id !== payload.id);
                localStorage.setItem('pendingQueue', JSON.stringify(pendingQueue));
                updatePendingBadge();
            });

            currentBoxId = null;
            boxItems = [];
            document.getElementById('boxIdInput').value = '';
            document.getElementById('submitReceptionBtn').disabled = true;
            closeModal('boxContentsModal');
        }

        function updatePendingBadge() {
            document.getElementById('pendingBadge').textContent = pendingQueue.length;
        }

        function showSnackbar(message, undoCallback) {
            const snackbar = document.getElementById('snackbar');
            const messageEl = document.getElementById('snackbarMessage');
            const undoBtn = document.getElementById('undoBtn');

            messageEl.textContent = message;
            snackbar.classList.add('show');

            lastAction = undoCallback;

            undoBtn.onclick = () => {
                if (lastAction) {
                    lastAction();
                    lastAction = null;
                }
                hideSnackbar();
            };

            clearTimeout(snackbarTimeout);
            snackbarTimeout = setTimeout(hideSnackbar, 8000);
        }

        function hideSnackbar() {
            document.getElementById('snackbar').classList.remove('show');
            clearTimeout(snackbarTimeout);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
        }

        init();
    </script>
</body>
</html>
